<!DOCTYPE html>
<html lang="es">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <meta charset="UTF-8">
    <title>Dashboard - Tienda de Videojuegos</title>
    <link rel="stylesheet" href="css/dashboard.css">
</head>

<body>
    <header>
        <div class="header-brand">
            <img src="assets/img/logofixed.jpg" alt="Logo de la Tienda" id="site-logo">
            <h1>üéÆ Tienda de Videojuegos</h1>
        </div>
        <nav>
            <span id="welcome-message"></span>
            <a href="cart.html">üõí Carrito (<span id="cart-count">0</span>)</a>
            <button id="logoutButton">Cerrar Sesi√≥n</button>
        </nav>
    </header>

    <main>

        <section id="filters">
            <label for="category-select">Filtrar por Consola:</label>
            <select id="category-select">
                <option value="0">Todas las Consolas</option>
            </select>
        </section>

        <section id="recent-views-container" style="display: none;">
            <h2>‚≠ê Vistos Recientemente</h2>
            <div id="recent-products-list">
                <p id="no-recent-views" style="text-align: center; display: none;">No hay productos vistos
                    recientemente.</p>
            </div>
        </section>

        <section id="featured-products">
            <h2>üî• Productos Destacados</h2>
            <div id="featured-container" class="products-container">
            </div>
        </section>

        <section id="all-products">
            <h2>Cat√°logo Completo</h2>
            <div id="products-container" class="products-container">
            </div>
        </section>

    </main>

    <script src="js/StorageManager.js"></script>
    <script src="js/ApiService.js"></script>
    <script>

        // Funci√≥n auxiliar para obtener el nombre de la categor√≠a por ID
        function getCategoryName(id, categories) {
            // Se asegura una comparaci√≥n robusta para la categor√≠a (en caso de inconsistencia de tipos)
            const category = categories.find(c => String(c.id) == String(id));
            return category ? category.name : 'Desconocida';
        }

        // -----------------------------------------------------------------
        // FUNCIONES DE RENDERIZADO
        // -----------------------------------------------------------------

        function renderCategories(categories) {
            const select = document.getElementById('category-select');
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
            // A√±adir listener para filtrar
            select.addEventListener('change', renderProducts);
        }

        // Funci√≥n para crear la tarjeta de producto
        function createProductCard(product, categories = []) {
            const card = document.createElement('div');
            card.className = 'product-card' + (product.featured ? ' featured' : '');
            card.dataset.productId = product.id;

            const consoleName = product.category_name || getCategoryName(product.id_categoria, categories);

            // L√≥gica para la imagen
            const imageHtml = product.image_url
                ? `<img src="${product.image_url}" alt="${product.name}">`
                : '';

            card.innerHTML = `
                ${imageHtml} 
                <h3>${product.name}</h3>
                <p class="category">Consola: ${consoleName}</p>
                <p>Formato: <strong>${product.formato}</strong></p>
                <p>${product.description || ''}</p>
                <p class="price">${product.price.toFixed(2)} ‚Ç¨</p>
                <p class="stock">Stock: ${product.stock}</p>
                <button class="add-to-cart-btn" data-product-id="${product.id}" 
                    ${product.stock === 0 ? 'disabled' : ''}>
                    ${product.stock === 0 ? 'Agotado' : 'A√±adir al Carrito'}
                </button>
            `;
            return card;
        };


        function renderProducts() {
            const storeData = StorageManager.getStoreData();
            // Asumiendo que los datos de la tienda tienen la propiedad 'products'
            if (!storeData || !storeData.products || !storeData.categories) return;

            const products = storeData.products;
            const categories = storeData.categories;

            const categoryId = parseInt(document.getElementById('category-select').value);

            // Filtrar productos por categor√≠a seleccionada
            const filteredProducts = categoryId === 0
                ? products
                : products.filter(p => p.id_categoria === categoryId);

            const allProductsContainer = document.getElementById('products-container');
            const featuredContainer = document.getElementById('featured-container');

            allProductsContainer.innerHTML = '';
            featuredContainer.innerHTML = '';

            // Separar productos destacados
            const featuredProducts = filteredProducts.filter(p => p.featured);
            const standardProducts = filteredProducts.filter(p => !p.featured);

            // Renderizar Destacados
            featuredProducts.forEach(product => {
                featuredContainer.appendChild(createProductCard(product, categories));
            });

            // Renderizar el resto del cat√°logo
            standardProducts.forEach(product => {
                allProductsContainer.appendChild(createProductCard(product, categories));
            });

            // Actualizar contador del carrito
            updateCartCount();
        }

        function updateCartCount() {
            const cartItems = StorageManager.getCart();
            const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-count').textContent = totalItems;
        }

        /**
         * Llama al API para obtener los detalles de los productos vistos recientemente 
         * y los renderiza en la secci√≥n "Vistos Recientemente".
         */
        async function renderRecentViews() {
            const viewedIds = StorageManager.getProductsViewed();
            const token = StorageManager.getToken();
            const container = document.getElementById('recent-products-list');
            const recentViewsSection = document.getElementById('recent-views-container');

            container.innerHTML = '';

            if (viewedIds.length === 0) {
                recentViewsSection.style.display = 'none';
                return;
            }

            recentViewsSection.style.display = 'block';

            try {
                // LLAMADA FINAL A LA API: Obtener detalles completos de los IDs vistos
                const recentProducts = await ApiService.getRecentProducts(viewedIds, token);

                if (recentProducts.length === 0) {
                    document.getElementById('no-recent-views').style.display = 'block';
                    return;
                }

                document.getElementById('no-recent-views').style.display = 'none';

                // Renderizar los productos devueltos por la API
                recentProducts.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.dataset.productId = product.id;

                    // L√≥gica para la imagen
                    const imageHtml = product.image_url
                        ? `<img src="${product.image_url}" alt="${product.name}">`
                        : '';

                    // El backend ya nos devuelve category_name
                    card.innerHTML = `
                        ${imageHtml}
                        <h4>${product.name}</h4>
                        <p class="category">${product.category_name} - ${product.formato}</p>
                        <p class="price">${product.price.toFixed(2)} ‚Ç¨</p>
                        <button class="add-to-cart-btn" data-product-id="${product.id}" 
                            ${product.stock === 0 ? 'disabled' : ''}>
                            A√±adir
                        </button>
                    `;
                    container.appendChild(card);
                });

            } catch (error) {
                console.error('Error al cargar productos vistos:', error);
                container.innerHTML = `<p style="color: red;">No se pudieron cargar los productos vistos recientemente.</p>`;
            }
        }

        // -----------------------------------------------------------------
        // FUNCIONES DE EVENTOS Y L√ìGICA
        // -----------------------------------------------------------------

        function handleLogout() {
            StorageManager.clearAll();
            window.location.href = 'login.html';
        }

        function setupCartListeners() {
            // Usamos 'main' como contenedor principal para el event delegation
            const container = document.querySelector('main');

            // 1. Listener para el bot√≥n "A√±adir al Carrito"
            container.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-to-cart-btn')) {

                    // üö® PASO 1: Obtener el ID y normalizarlo (limpiar espacios)
                    const rawProductId = e.target.dataset.productId;
                    const productId = rawProductId ? rawProductId.trim() : null; 

                    const storeData = StorageManager.getStoreData();
                    let product = null;

                    // üö® PASO 2: La b√∫squeda M√ÅS ROBUSTA (Usando 'products' y normalizando)
                    // Se asegura que existe el ID, los datos de la tienda, y el array de productos
                    if (productId && storeData && storeData.products) { 
                        // Usamos String().trim() en p.id y '==' para una comparaci√≥n robusta
                        product = storeData.products.find(p => String(p.id).trim() == productId); 
                    }

                    // L√≥gica del carrito
                    StorageManager.addToCart(productId);
                    updateCartCount();

                    // Alerta final (usando .name y productName)
                    if (product && product.name) {
                        alert(`"${product.name}" a√±adido al carrito`);
                    } else {
                        // Mensaje de ayuda si la b√∫squeda falla
                        alert(`Error de b√∫squeda: Se a√±adi√≥ el producto. ID buscado: ${productId}.`);
                    }
                }
            }); // Cierre Correcto del Listener 1

            // 2. Listener para a√±adir producto a vistos recientemente (al hacer click en la tarjeta)
            container.addEventListener('click', (e) => {
                let target = e.target;
                // Subir hasta encontrar el elemento con data-product-id (la tarjeta)
                while (target && !target.dataset.productId && target !== container) {
                    target = target.parentElement;
                }
                if (target && target.dataset.productId) {
                    // Usamos el ID como string (m√°s seguro que parseInt)
                    const productId = target.dataset.productId.trim(); 
                    
                    // Solo si no estamos haciendo click en el bot√≥n (que ya tiene su propia acci√≥n)
                    if (!e.target.classList.contains('add-to-cart-btn')) {
                        StorageManager.addProductViewed(productId);
                        // Re-renderizamos la secci√≥n de vistos inmediatamente
                        renderRecentViews();
                    }
                }
            }); // Cierre Correcto del Listener 2
        } // Cierre Correcto de setupCartListeners()

        // -----------------------------------------------------------------
        // INICIALIZACI√ìN
        // -----------------------------------------------------------------

        function initDashboard() {
            // 1. VERIFICAR AUTENTICACI√ìN
            const token = StorageManager.getToken();
            const storeData = StorageManager.getStoreData();

            if (!token || !storeData) {
                // Si no hay token o datos de la tienda, redirigir al login
                window.location.href = 'login.html';
                return;
            }

            // 2. MOSTRAR MENSAJE DE BIENVENIDA
            const username = storeData.username || 'Usuario';
            document.getElementById('welcome-message').textContent = `Bienvenido, ${username}.`;

            // 3. RENDERIZAR INTERFAZ
            renderCategories(storeData.categories);
            renderProducts();
            renderRecentViews(); 

            // 4. CONFIGURAR CIERRE DE SESI√ìN
            document.getElementById('logoutButton').addEventListener('click', handleLogout);

            // 5. CONFIGURAR LISTENERS DEL CARRITO Y VISTOS
            setupCartListeners();
        }

        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>

</html>