<!DOCTYPE html>
<html lang="es">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <meta charset="UTF-8">
    <title>Dashboard - Tienda de Videojuegos</title>
    <link rel="stylesheet" href="css/dashboard.css">
</head>

<body>
    <header>
        <div class="header-brand">
            <img src="assets/img/logofixed.jpg" alt="Logo de la Tienda" id="site-logo">
            <h1>ðŸŽ® Tienda de Videojuegos</h1>
        </div>
        <nav>
            <span id="welcome-message"></span>
            <a href="cart.html">ðŸ›’ Carrito (<span id="cart-count">0</span>)</a>
            <button id="logoutButton">Cerrar SesiÃ³n</button>
        </nav>
    </header>

    <main>

        <section id="filters">
            <label for="category-select">Filtrar por Consola:</label>
            <select id="category-select">
                <option value="0">Todas las Consolas</option>
            </select>
        </section>

        <section id="recent-views-container" style="display: none; margin-top: 20px;">
            <h3 style="color:#ffc107;">Productos vistos recientemente</h3>
            <div id="recent-views-list" class="d-flex gap-3" style="flex-wrap:wrap;"></div>
        </section>

        <section id="featured-products">
            <h2>ðŸ”¥ Productos Destacados</h2>
            <div id="featured-container" class="products-container">
            </div>
        </section>

        <section id="all-products">
            <h2>CatÃ¡logo Completo</h2>
            <div id="products-container" class="products-container">
            </div>
        </section>

    </main>

    <script src="js/StorageManager.js"></script>
    <script src="js/ApiService.js"></script>
    <script>

        // FunciÃ³n auxiliar para obtener el nombre de la categorÃ­a por ID
        function getCategoryName(id, categories) {
            // Se asegura una comparaciÃ³n robusta para la categorÃ­a (en caso de inconsistencia de tipos)
            const category = categories.find(c => String(c.id) == String(id));
            return category ? category.name : 'Desconocida';
        }

        // -----------------------------------------------------------------
        // FUNCIONES DE RENDERIZADO
        // -----------------------------------------------------------------

        function renderCategories(categories) {
            const select = document.getElementById('category-select');
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                select.appendChild(option);
            });
            // AÃ±adir listener para filtrar
            select.addEventListener('change', renderProducts);
        }

        // FunciÃ³n para crear la tarjeta de producto
        function createProductCard(product, categories = []) {
            const card = document.createElement('div');
            card.className = 'product-card' + (product.featured ? ' featured' : '');
            card.dataset.productId = product.id;

            const consoleName = product.category_name || getCategoryName(product.id_categoria, categories);

            // LÃ³gica para la imagen
            const imageHtml = product.image_url
                ? `<img src="${product.image_url}" alt="${product.name}">`
                : '';

            card.innerHTML = `
                ${imageHtml} 
                <h3>${product.name}</h3>
                <p class="category">Consola: ${consoleName}</p>
                <p>Formato: <strong>${product.formato}</strong></p>
                <p>${product.description || ''}</p>
                <p class="price">${product.price.toFixed(2)} â‚¬</p>
                <p class="stock">Stock: ${product.stock}</p>
                <button class="add-to-cart-btn" data-product-id="${product.id}" 
                    ${product.stock === 0 ? 'disabled' : ''}>
                    ${product.stock === 0 ? 'Agotado' : 'AÃ±adir al Carrito'}
                </button>
            `;
            return card;
        };


        function renderProducts() {
            const storeData = StorageManager.getStoreData();
            // Asumiendo que los datos de la tienda tienen la propiedad 'products'
            if (!storeData || !storeData.products || !storeData.categories) return;

            const products = storeData.products;
            const categories = storeData.categories;

            const categoryId = parseInt(document.getElementById('category-select').value);

            // Filtrar productos por categorÃ­a seleccionada
            const filteredProducts = categoryId === 0
                ? products
                : products.filter(p => p.id_categoria === categoryId);

            const allProductsContainer = document.getElementById('products-container');
            const featuredContainer = document.getElementById('featured-container');

            allProductsContainer.innerHTML = '';
            featuredContainer.innerHTML = '';

            // Separar productos destacados
            const featuredProducts = filteredProducts.filter(p => p.featured);
            const standardProducts = filteredProducts.filter(p => !p.featured);

            // Renderizar Destacados
            featuredProducts.forEach(product => {
                featuredContainer.appendChild(createProductCard(product, categories));
            });

            // Renderizar el resto del catÃ¡logo
            standardProducts.forEach(product => {
                allProductsContainer.appendChild(createProductCard(product, categories));
            });

            // Actualizar contador del carrito
            updateCartCount();
        }

        function updateCartCount() {
            const cartItems = StorageManager.getCart();
            const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-count').textContent = totalItems;
        }

        /**
         * Llama al API para obtener los detalles de los productos vistos recientemente 
         * y los renderiza en la secciÃ³n "Vistos Recientemente".
         */
        function renderRecentViews() {
            const recentIds = StorageManager.getViewedProducts();
            const storeData = StorageManager.getStoreData();
            const container = document.getElementById('recent-views-container');
            const list = document.getElementById('recent-views-list');
            if (!container || !list) return;

            list.innerHTML = '';
            if (!recentIds || recentIds.length === 0 || !storeData || !storeData.products) {
                container.style.display = 'none';
                return;
            }

            recentIds.forEach(id => {
                const product = storeData.products.find(p => String(p.id) === String(id));
                if (!product) return;
                const card = document.createElement('div');
                card.className = 'recent-card';
                card.style.width = '160px';
                card.style.background = '#111';
                card.style.padding = '10px';
                card.style.borderRadius = '6px';
                card.style.color = '#fff';
                card.style.textAlign = 'center';
                card.style.margin = '6px';
                card.innerHTML = `
            <a href="product.html?id=${product.id}" style="color:inherit; text-decoration:none;">
                <div style="height:100px; display:flex; align-items:center; justify-content:center; margin-bottom:8px;">
                    <img src="${product.image_url || 'assets/img/no-image.png'}" alt="${product.name}" style="max-width:100%; max-height:100%;">
                </div>
                <div style="font-size:14px;">${product.name}</div>
                <div style="color:#ffc107; font-weight:bold; margin-top:6px;">${Number(product.price).toFixed(2)} â‚¬</div>
            </a>
        `;
                list.appendChild(card);
            });

            container.style.display = 'block';
        }

        // -----------------------------------------------------------------
        // FUNCIONES DE EVENTOS Y LÃ“GICA
        // -----------------------------------------------------------------

        function handleLogout() {
            StorageManager.clearAuthData();  // âœ… Cambio: clearAll() â†’ clearAuthData()
            StorageManager.clearCart();      // âœ… AÃ±adido: Limpiar tambiÃ©n el carrito
            window.location.href = 'login.html';
        }

        function setupCartListeners() {
            // Usamos 'main' como contenedor principal para el event delegation
            const container = document.querySelector('main');

            // 1. Listener para el botÃ³n "AÃ±adir al Carrito"
            container.addEventListener('click', (e) => {
                if (e.target.classList.contains('add-to-cart-btn')) {

                    // ðŸš¨ PASO 1: Obtener el ID y normalizarlo (limpiar espacios)
                    const rawProductId = e.target.dataset.productId;
                    const productId = rawProductId ? rawProductId.trim() : null;

                    const storeData = StorageManager.getStoreData();
                    let product = null;

                    // ðŸš¨ PASO 2: La bÃºsqueda MÃS ROBUSTA (Usando 'products' y normalizando)
                    // Se asegura que existe el ID, los datos de la tienda, y el array de productos
                    if (productId && storeData && storeData.products) {
                        // Usamos String().trim() en p.id y '==' para una comparaciÃ³n robusta
                        product = storeData.products.find(p => String(p.id).trim() == productId);
                    }

                    // LÃ³gica del carrito
                    StorageManager.addToCart(productId);
                    updateCartCount();

                    // Alerta final (usando .name y productName)
                    if (product && product.name) {
                        alert(`"${product.name}" aÃ±adido al carrito`);
                    } else {
                        // Mensaje de ayuda si la bÃºsqueda falla
                        alert(`Error de bÃºsqueda: Se aÃ±adiÃ³ el producto. ID buscado: ${productId}.`);
                    }
                }
            }); // Cierre Correcto del Listener 1

            // 2. Listener para aÃ±adir producto a vistos recientemente (al hacer click en la tarjeta)
            container.addEventListener('click', (e) => {
                let target = e.target;
                // Subir hasta encontrar el elemento con data-product-id (la tarjeta)
                while (target && !target.dataset.productId && target !== container) {
                    target = target.parentElement;
                }
                if (target && target.dataset.productId) {
                    const productId = target.dataset.productId.trim();

                    if (!e.target.classList.contains('add-to-cart-btn')) {
-                        StorageManager.addProductViewed(productId);
+                        StorageManager.addViewedProduct(productId);
                        renderRecentViews();
                    }
                }
            }); // Cierre Correcto del Listener 2
        } // Cierre Correcto de setupCartListeners()

        // -----------------------------------------------------------------
        // INICIALIZACIÃ“N
        // -----------------------------------------------------------------

        function initDashboard() {
            // 1. VERIFICAR AUTENTICACIÃ“N
            const token = StorageManager.getToken();
            const storeData = StorageManager.getStoreData();

            if (!token || !storeData) {
                // Si no hay token o datos de la tienda, redirigir al login
                window.location.href = 'login.html';
                return;
            }

            // 2. MOSTRAR MENSAJE DE BIENVENIDA
            const username = storeData.username || 'Usuario';
            document.getElementById('welcome-message').textContent = `Bienvenido, ${username}.`;

            // 3. RENDERIZAR INTERFAZ
            renderCategories(storeData.categories);
            renderProducts();
            renderRecentViews();

            // 4. CONFIGURAR CIERRE DE SESIÃ“N
            document.getElementById('logoutButton').addEventListener('click', handleLogout);

            // 5. CONFIGURAR LISTENERS DEL CARRITO Y VISTOS
            setupCartListeners();
        }

        document.addEventListener('DOMContentLoaded', () => {
        if (typeof initDashboard === 'function') {
            initDashboard();
        } else {
            // Fallback seguro
            if (typeof renderProducts === 'function') renderProducts();
            renderRecentViews();
        }
    });

    </script>
</body>

</html>