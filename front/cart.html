<!DOCTYPE html>
<html lang="es">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="css/cart.css">
    <meta charset="UTF-8">
    <title>Carrito de Compras - Tienda de Videojuegos</title>
    <link rel="stylesheet" href="css/cart.css">
</head>

<body>
    <header>
        <div class="header-brand">
            <img src="assets/img/logofixed.jpg" alt="Logo de la Tienda" id="site-logo">
            <h1>üõí Carrito de Compras</h1>
        </div>
        <nav>
            <a href="dashboard.html">Volver a la Tienda</a>
            <button id="clearCartButton">Vaciar Carrito</button>
        </nav>
    </header>

    <main>
        <section id="cart-details">
            <h2>Resumen del Pedido</h2>

            <div id="cart-items-container">
                <p id="empty-cart-message" style="text-align: center; margin-top: 20px; display: none;">Tu carrito est√°
                    vac√≠o.</p>
            </div>

            <div id="cart-summary" style="margin-top: 30px; padding: 15px; border-top: 2px solid #333;">
                <!-- Total estimado -->
                <div style="background:#111; padding:12px; border-radius:4px; color:#ffc107; display:flex; align-items:center; justify-content:space-between;">
                    <div>Total Estimado: <strong><span id="estimated-total">0.00</span> ‚Ç¨</strong></div>
                    <button id="checkoutButton" class="btn btn-success" style="margin-left:20px;">
                        Finalizar Compra
                    </button>
                </div>
            </div>
            <p id="checkout-message" style="margin-top: 10px; font-weight: bold;"></p>



        </section>
    </main>

    <script src="js/StorageManager.js"></script>
    <script src="js/ApiService.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', initCartPage);

        // Functi√≥n auxiliar para obtener los detalles de un producto por ID desde el storeData
        function getProductDetails(productId, storeProducts) {
            // Usa String().trim() y el comparador no estricto (==) para manejar IDs mixtos (n√∫meros o strings)
            return storeProducts.find(p => String(p.id).trim() == String(productId).trim());
        }

        function renderCart() {
            const cartItems = StorageManager.getCart();
            const storeData = StorageManager.getStoreData();
            const container = document.getElementById('cart-items-container');
            const totalElement = document.getElementById('estimated-total');
            const emptyMessage = document.getElementById('empty-cart-message');
            const checkoutButton = document.getElementById('checkoutButton');

            // Proteger contra DOM incompleto
            if (!container) return;

            container.innerHTML = '';

            if (!cartItems || cartItems.length === 0 || !storeData || !storeData.products) {
                if (emptyMessage) emptyMessage.style.display = 'block';
                if (totalElement) totalElement.textContent = '0.00';
                if (checkoutButton) checkoutButton.disabled = true;
                return;
            }

            if (emptyMessage) emptyMessage.style.display = 'none';
            if (checkoutButton) checkoutButton.disabled = false;
            let estimatedTotal = 0;

            cartItems.forEach(item => {
                const product = getProductDetails(item.productId, storeData.products);

                if (product) {
                    const subtotal = product.price * item.quantity;
                    estimatedTotal += subtotal;

                    const cartItemDiv = document.createElement('div');
                    cartItemDiv.className = 'cart-item';

                    const imageHtml = product.image_url
                        ? `<img src="${product.image_url}" alt="${product.name}" style="width: 200px; height: auto; margin-right: 15px; float: left;">`
                        : '';

                    cartItemDiv.innerHTML = `
                        ${imageHtml}
                        <div class="item-info">
                            <h4>${product.name} (${product.formato})</h4>
                            <p>Precio Unitario: ${product.price.toFixed(2)} ‚Ç¨</p>
                            <p>Cantidad: ${item.quantity} | Stock visible: ${product.stock}</p>
                            <p>Subtotal: <strong>${subtotal.toFixed(2)} ‚Ç¨</strong></p>
                        </div>
                        <button class="remove-item-btn" data-product-id="${product.id}">Eliminar</button>
                    `;
                    container.appendChild(cartItemDiv);
                } else {
                    console.error(`Producto con ID ${item.productId} no encontrado en el cat√°logo.`);
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'alert alert-danger';
                    errorDiv.innerHTML = `Error: No se pudo cargar el producto con ID <strong>${item.productId}</strong>. Por favor, vac√≠a el carrito.`;
                    container.appendChild(errorDiv);
                }
            });

            if (totalElement) totalElement.textContent = estimatedTotal.toFixed(2);

            // A√±adir listeners para los botones de eliminar
            document.querySelectorAll('.remove-item-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.target.dataset.productId;
                    StorageManager.removeFromCart(productId);
                    renderCart(); // Re-renderizar el carrito
                });
            });
        }

                async function handleCheckout() {
            // No guardamos la referencia aqu√≠ de forma permanente, la buscamos cuando la necesitamos
            const checkoutButton = document.getElementById('checkoutButton');

            const setMessage = (text, color = 'black') => {
                const msgEl = document.getElementById('checkout-message');
                if (msgEl) {
                    msgEl.textContent = text;
                    // proteger acceso a .style por si msgEl no es un elemento v√°lido
                    if (msgEl.style) msgEl.style.color = color;
                } else {
                    // fallback visible
                    console.warn('checkout-message no encontrado, fallback a alert');
                    alert(text);
                }
            };

            if (!checkoutButton) {
                setMessage('Error interno: bot√≥n de finalizar no encontrado.', 'red');
                return;
            }

            const token = StorageManager.getToken();
            const cartItems = StorageManager.getCart();

            console.log('Token:', token);
            console.log('Cart Items:', cartItems);

            if (!token) {
                setMessage('Error: No est√°s autenticado.', 'red');
                return;
            }
            if (!cartItems || cartItems.length === 0) {
                setMessage('El carrito est√° vac√≠o.', 'red');
                return;
            }

            const apiCartItems = cartItems.map(item => ({
                id: item.productId,
                quantity: item.quantity
            }));
            console.log('API Cart Items a enviar:', apiCartItems);

            checkoutButton.disabled = true;
            setMessage('Procesando pago y validando stock...', 'black');

            try {
                const response = await ApiService.checkout(apiCartItems, token);
                console.log('Respuesta del servidor:', response);

                const finalTotal = (response && typeof response.final_total !== 'undefined')
                    ? Number(response.final_total).toFixed(2)
                    : null;

                if (finalTotal !== null) {
                    setMessage(`‚úÖ Compra realizada. Total final: ${finalTotal} ‚Ç¨.`, 'green');
                } else if (response && response.message) {
                    setMessage(`‚úÖ ${response.message}`, 'green');
                } else {
                    setMessage('‚úÖ Compra procesada correctamente.', 'green');
                }

                StorageManager.clearCart();
                if (typeof renderCart === 'function') renderCart();

            } catch (error) {
                console.error('Error en checkout:', error);
                setMessage(`‚ùå Error al finalizar la compra: ${error.message || error}`, 'red');
                if (checkoutButton) checkoutButton.disabled = false;
            }
        }

        function handleClearCart() {
            if (confirm("¬øEst√°s seguro de que quieres vaciar el carrito?")) {
                StorageManager.clearCart();
                renderCart();
                document.getElementById('checkout-message').textContent = '';
            }
        }

        function initCartPage() {
            // evitar errores si los elementos no existen
            const clearCartBtn = document.getElementById('clearCartButton');
            const checkoutButton = document.getElementById('checkoutButton');

            // Render inicial
            if (typeof renderCart === 'function') renderCart();

            if (checkoutButton) {
                checkoutButton.removeEventListener('click', handleCheckout); // seguro
                checkoutButton.addEventListener('click', handleCheckout);
            } else {
                console.warn('checkoutButton no existe en initCartPage');
            }

            if (clearCartBtn) {
                clearCartBtn.removeEventListener('click', handleClearCart);
                clearCartBtn.addEventListener('click', handleClearCart);
            }

            // limpiar mensaje inicial si existe
            const msgEl = document.getElementById('checkout-message');
            if (msgEl) msgEl.textContent = '';
        }
    </script>
</body>

</html>