<!DOCTYPE html>
<html lang="es">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="assets/css/style.css">
    <meta charset="UTF-8">
    <title>Carrito de Compras - Tienda de Videojuegos</title>
    <link rel="stylesheet" href="css/cart.css">
</head>

<body>
    <header>
        <div class="header-brand">
            <img src="assets/img/logofixed.jpg" alt="Logo de la Tienda" id="site-logo">
            <h1>üõí Carrito de Compras</h1>
        </div>
        <nav>
            <a href="dashboard.html">Volver a la Tienda</a>
            <button id="clearCartButton">Vaciar Carrito</button>
        </nav>
    </header>

    <main>
        <section id="cart-details">
            <h2>Resumen del Pedido</h2>

            <div id="cart-items-container">
                <p id="empty-cart-message" style="text-align: center; margin-top: 20px; display: none;">Tu carrito est√°
                    vac√≠o.</p>
            </div>

            <div id="cart-summary" style="margin-top: 30px; padding: 15px; border-top: 2px solid #333;">
                <h3>Total Estimado: <span id="estimated-total">0.00 ‚Ç¨</span></h3>
                <button id="checkoutButton" disabled>Finalizar Compra</button>
            </div>

            <p id="checkout-message" style="margin-top: 10px; font-weight: bold;"></p>

        </section>
    </main>

    <script src="js/StorageManager.js"></script>
    <script src="js/ApiService.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', initCartPage);

        // Functi√≥n auxiliar para obtener los detalles de un producto por ID desde el storeData
        function getProductDetails(productId, storeProducts) {
            // Usa String().trim() y el comparador no estricto (==) para manejar IDs mixtos (n√∫meros o strings)
            return storeProducts.find(p => String(p.id).trim() == String(productId).trim());
        }

        function renderCart() {
            const cartItems = StorageManager.getCart();
            const storeData = StorageManager.getStoreData();
            const container = document.getElementById('cart-items-container');
            const totalElement = document.getElementById('estimated-total');
            const emptyMessage = document.getElementById('empty-cart-message');
            const checkoutButton = document.getElementById('checkoutButton');

            // Limpiamos el contenedor para empezar de nuevo
            container.innerHTML = '';

            if (!cartItems || cartItems.length === 0 || !storeData || !storeData.products) {
                // Caso: carrito vac√≠o o datos no cargados
                emptyMessage.style.display = 'block';
                totalElement.textContent = '0.00 ‚Ç¨';
                checkoutButton.disabled = true;
                return;
            }

            emptyMessage.style.display = 'none';
            checkoutButton.disabled = false;
            let estimatedTotal = 0;

            cartItems.forEach(item => {
                // üö® CORRECCI√ìN CR√çTICA: Se lee el ID correctamente usando 'item.productId'
                const product = getProductDetails(item.productId, storeData.products);

                if (product) {
                    const subtotal = product.price * item.quantity;
                    estimatedTotal += subtotal;

                    const cartItemDiv = document.createElement('div');
                    cartItemDiv.className = 'cart-item';

                    // L√≥gica para la imagen
                    const imageHtml = product.image_url
                        ? `<img src="${product.image_url}" alt="${product.name}" style="width: 80px; height: auto; margin-right: 15px; float: left;">`
                        : '';

                    cartItemDiv.innerHTML = `
                        ${imageHtml}
                        <div class="item-info">
                            <h4>${product.name} (${product.formato})</h4>
                            <p>Precio Unitario: ${product.price.toFixed(2)} ‚Ç¨</p>
                            <p>Cantidad: ${item.quantity} | Stock visible: ${product.stock}</p>
                            <p>Subtotal: <strong>${subtotal.toFixed(2)} ‚Ç¨</strong></p>
                        </div>
                        <button class="remove-item-btn" data-product-id="${product.id}">Eliminar</button>
                    `;
                    container.appendChild(cartItemDiv);
                } else {
                    // Muestra una fila de error si un producto no se puede encontrar
                    console.error(`Producto con ID ${item.productId} no encontrado en el cat√°logo.`);
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'alert alert-danger';
                    errorDiv.innerHTML = `Error: No se pudo cargar el producto con ID <strong>${item.productId}</strong>. Por favor, vac√≠a el carrito.`;
                    container.appendChild(errorDiv);
                }
            });

            totalElement.textContent = estimatedTotal.toFixed(2) + ' ‚Ç¨';

            // A√±adir listeners para los botones de eliminar
            document.querySelectorAll('.remove-item-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = e.target.dataset.productId;
                    StorageManager.removeFromCart(productId);
                    renderCart(); // Re-renderizar el carrito
                });
            });
        }

        async function handleCheckout() {
            const token = StorageManager.getToken();
            const cartItems = StorageManager.getCart();
            const messageElement = document.getElementById('checkout-message');
            messageElement.textContent = '';

            if (!token || cartItems.length === 0) {
                messageElement.textContent = !token ? 'Error: No est√°s autenticado.' : 'El carrito est√° vac√≠o.';
                messageElement.style.color = 'red';
                return;
            }

            const checkoutButton = document.getElementById('checkoutButton');
            checkoutButton.disabled = true;
            messageElement.textContent = 'Procesando pago y validando stock...';
            messageElement.style.color = 'black';

            try {
                // Llama al API para validar el carrito y completar el "pedido"
                const response = await ApiService.checkout(cartItems, token);

                messageElement.textContent = `‚úÖ √âxito: Pedido validado. El total final del servidor fue de ${response.final_total.toFixed(2)} ‚Ç¨.`;
                messageElement.style.color = 'green';

                // Limpiar el carrito despu√©s de la compra exitosa
                StorageManager.clearCart();
                renderCart();

            } catch (error) {
                messageElement.textContent = `‚ùå Error al finalizar la compra: ${error.message}`;
                messageElement.style.color = 'red';
                checkoutButton.disabled = false; // Permitir reintento
            }
        }

        function handleClearCart() {
            if (confirm("¬øEst√°s seguro de que quieres vaciar el carrito?")) {
                StorageManager.clearCart();
                renderCart();
                document.getElementById('checkout-message').textContent = '';
            }
        }

        function initCartPage() {
            // 1. Verificar Autenticaci√≥n
            if (!StorageManager.getToken()) {
                window.location.href = 'login.html';
                return;
            }

            // 2. Renderizar carrito inicialmente
            renderCart();

            // 3. Configurar listeners
            document.getElementById('checkoutButton').addEventListener('click', handleCheckout);
            document.getElementById('clearCartButton').addEventListener('click', handleClearCart);
        }
    </script>
</body>

</html>